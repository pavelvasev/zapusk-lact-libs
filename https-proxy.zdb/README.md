# https-proxy

Предназначение: https endpoint, проксирующий входящие https-запросы на localhost.

## Пример использования
На хост-машине в какой-нибудь zdb-программе:
```
####### https-proxy
# параметры не требуются
```
Результат: развернется chroot-а и в ней haproxy, а также на хосте появится скрипт /etc/init.d/https-proxy.

## Связи
* **/data/https-proxy/auto-certs** - каталог на хост-машине с сертификатами
* **/data/https-proxy/user-certs** - каталог на хост-машине с сертификатами

Считается, что внешние компоненты кладут сертификаты в эти каталоги.
Например [host-certbot](../host-certbot.zdb)

## Устройство

Работает на haproxy, различает домены на основе SNI.

Выставляет inotify на вышеуказанные каталоги и перезагружается при изменениях в них.
Это позволяет подхватывать новые сертификаты.

## Примечания

1. 
Запись в https-proxy/auto-certs и user-certs каталоги влечет reload у haproxy.
Если при этом там оказались плохие файлы (хоть что-то кроме pem), haproxy выдает
ошибку что reload не удалась. При этом продоложает работу (видимо на старых данных).

Таким образом если туда разместить плохие данные, то haproxy не будет reload-иться
и не загрузит новых других сертификатов.

Restart при этом повлечет останов haproxy.

2. 
Лог-файл ведется не совсем ясно как, см конфигурацию haproxy.
При этом дополнительно идет запись в /etc/rsyslog.d, которая нами на хост сейчас
не проводится.

## См также

* [host-certbot](../host-certbot.zdb)
* [https-cert-request](../https-cert-request.zdb)
* [https-cert-item](../https-cert-item.zdb)
