# chroota

Создает chroot-машину debian.

Особенности:
* Использует для этого (chroot-tool)[https://github.com/lactop/chroot-tool], который задействует chroot и debootstrap.
* Совместимо с типом (employ)[../employ], что позволяет программировать содержимое машины через zapusk-программы.

# Пример

```
####### myapp
[employ]
[chroota]
[ruby]
[git]
repo=....
dir=/chroot.d/rubyapp
[generate-initd]
path=/chroot.d/rubyapp/server.rb
proxy=true
```

# Примеры чрут

(https-proxy)[../https-proxy]

# Параметры
* **chroota_base_dir** - базовый каталог для развертывания чруты. Чрута будет установлена в каталог `{{chroota_base_dir}}/{{global_name}}`.
  По умолчанию `/zapusk.chroots`.
* **chroota_debian_version** - версия дебиан для установки. По умолчанию `buster`.

# Команды

Тип chroota при подаче команды apply преобразует ее в набор команд, каждая из которых имеет свой смысл.

apply => on,prehost,system-update,update,host

* **on** - включает чруту, монтируя все каталоги
* **prehost** - предварительные задачи. Выполняется на хосте.
* **system-update** - в эту команду предлагается записывать установку ПО. Выполняется в чруте.
* **apply** - основное развертывание и обновление настроек. Выполняется в чруте.
* **host** - заключительные задачи. Выполняются на хосте.

Все команды кроме on вызываются последовательно в порядке для всех компонент, встроенных в чруту. 
Таким образом, сначала всем компонентам подается команда prehost, затем system-update, и т.д.

**system-update** выполняется однократно, и для ее повторного запуска следует выполнить **system-update-force**.

Для команд prehost и host выставляется дополнительные переменные
* machine_root_dir - каталог чруты
* employ_name - имя чруты

# Автоматическое монтирование в хост-систему

Чруты автоматически прикрепляются к хост-системе в том смысле, что
* генерируется файл `/etc/init.d/chroota_name`, который при вызове перенаправляет команды в чруту
* он регистрируется в авто-запуске системы через `update-rc.d`

Таким образом, чрута может наладить реакцию на команды `start`, `stop`, `restart` и любые другие
и быть доступной через вызов сооответствуюего ей init-d скрипта.

Например, при установке чруты `https-proxy` появляется возможность вызывать `/etc/init.d/https-proxy start` и т.д.
